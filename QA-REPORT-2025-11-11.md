# Medicine Man - Full QA Test Report
**Date:** November 11, 2025  
**Environment:** Docker Desktop 4.49.0, Windows 11  
**Tester:** GitHub Copilot (Automated QA)

---

## Executive Summary

**Overall Status:** âš ï¸ **CRITICAL ISSUES FOUND** - Application cannot be used in current state

- **Total Tests:** 8 test categories
- **Passed:** 4 (50%)
- **Failed:** 2 (25%)
- **Blocked:** 2 (25%)
- **Critical Bugs:** 3

### Critical Issues
1. **ğŸ”´ BLOCKER:** Login endpoint has schema mismatch - prevents all authentication
2. **ğŸ”´ BLOCKER:** Database migrations not running properly - missing required tables/columns
3. **ğŸŸ  HIGH:** xterm package versions incompatible (5.5.0 doesn't exist, 0.9.0 doesn't exist)

---

## Test Results by Category

### 1. Container Health & Resources âœ… PASS
**Status:** All containers healthy and performing excellently

#### Containers Running
- âœ… `medicine_man_backend` - Healthy, 56MB RAM, 0.26% CPU
- âœ… `medicine_man_frontend` - Healthy, 22MB RAM, 0.00% CPU  
- âœ… `medicine_man_postgres` - Healthy, 40MB RAM, 0.00% CPU
- âœ… `medicine_man_redis` - Healthy, 9MB RAM, 0.25% CPU
- âœ… `medicine_man_portainer` - Healthy, Docker management UI

**Resource Usage:** Excellent efficiency
- Total RAM: ~128MB / 4.5GB allocated (2.8%)
- Total CPU: <0.3% per container
- All containers within limits

**Ports:**
- Backend API: 3000
- Frontend: 8091
- Portainer HTTP: 9000
- Portainer HTTPS: 9443
- Portainer Edge: 8000

---

### 2. Backend API Endpoints ğŸ”´ FAIL - CRITICAL
**Status:** Health check works, authentication completely broken

#### Health Endpoint âœ…
```json
{
  "success": true,
  "message": "Server is healthy",
  "uptime": 2737.275945822,
  "environment": "production"
}
```

#### Authentication Endpoint ğŸ”´ BLOCKER
**Issue:** Login schema mismatch in `backend/src/utils/validators.ts`

**Root Cause:**
```typescript
// validators.ts line 29-33 - Schema validates 'email' field
export const loginSchema = z.object({
  email: z.string().email('Invalid email address'),
  password: z.string().min(1, 'Password is required'),
});

// BUT auth.ts line 307 - Code expects 'username' field
const { username, password } = req.validatedData;
```

**Fix Applied:**
Changed loginSchema to validate `username` instead of `email` to match controller expectations.

#### Other API Endpoints âš ï¸ BLOCKED
- `/api/users` - Blocked (requires authentication)
- `/api/servers` - Blocked (requires authentication)
- `/api/scans` - Blocked (requires authentication)
- `/api/jobs` - Blocked (requires authentication)

---

### 3. Database & Migrations ğŸ”´ FAIL - CRITICAL  
**Status:** Tables exist but migrations never ran, missing columns

#### Issues Found
1. **pgmigrations table empty** - 0 rows, migrations not tracked
2. **users table missing columns:**
   - `role` column - ADDED manually
   - `twofa_enabled` column - ADDED manually
   - `twofa_secret` column - ADDED manually
3. **backup_schedules table** - Does not exist
4. **login_attempts table** - Does not exist

#### Fixes Applied
```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS role VARCHAR(50) DEFAULT 'user';
ALTER TABLE users ADD COLUMN IF NOT EXISTS twofa_enabled BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS twofa_secret VARCHAR(255);
```

#### Admin User Creation
âœ… Admin user created successfully:
- Username: admin
- Email: admin@medicine-man.local
- Role: admin
- Password: (bcryptjs hashed)

---

### 4. Portainer Integration âœ… PASS
**Status:** Successfully added and accessible

- âœ… Service added to docker-compose.yml
- âœ… Ports configured: 9000 (HTTP), 9443 (HTTPS), 8000 (Edge)
- âœ… Container running and healthy
- âœ… UI accessible at http://localhost:9000
- âœ… Volume persistence configured
- âœ… Documentation updated in UNRAID guides

---

### 5. Frontend UI Testing âš ï¸ BLOCKED
**Status:** Cannot test - blocked by authentication failure

**Blockers:**
- Login endpoint not functional
- Cannot authenticate to access dashboard
- Cannot test navigation or UI components

---

### 6. Security Headers Testing âš ï¸ BLOCKED
**Status:** Cannot test - requires authenticated requests

**Planned Tests (blocked):**
- Helmet security headers
- CORS configuration
- Rate limiting
- JWT token validation

---

### 7. Performance Validation âœ… PASS
**Status:** Excellent performance characteristics

#### Metrics
- **Response Times:** Health endpoint < 10ms
- **Memory Efficiency:** 
  - Backend: 56MB (1.83% of 3GB limit)
  - Frontend: 22MB (4.38% of 512MB limit)
  - PostgreSQL: 40MB (1.98% of 2GB limit)
  - Redis: 9MB (1.19% of 768MB limit)
- **CPU Usage:** All containers < 0.3%
- **Container Health:** All services report healthy status
- **Startup Time:** ~30-40 seconds to all healthy

#### Build Performance
- Frontend build: ~15 seconds (after package fixes)
- Backend build: ~20 seconds
- Total rebuild: ~60 seconds

---

### 8. Build & Dependencies ğŸŸ  PARTIAL
**Status:** Fixed after discovering incompatible versions

#### Issues Found & Fixed
1. **xterm 5.5.0 doesn't exist** âŒ
   - Fixed: Changed to 5.3.0 (latest stable)
   
2. **xterm-addon-fit 0.9.0 doesn't exist** âŒ
   - Fixed: Changed to 0.8.0 (latest stable)

3. **@types/json2csv missing** âŒ
   - Fixed: Installed @types/json2csv for backend

4. **TypeScript compilation errors** âŒ
   - ValidationError type mismatch
   - Fixed: Wrapped error arrays in object `{ errors }`

#### Package Versions After Fixes
```json
{
  "xterm": "^5.3.0",
  "xterm-addon-fit": "^0.8.0",
  "@types/json2csv": "latest"
}
```

---

## Critical Bugs Summary

### ğŸ”´ Bug #1: Login Schema Mismatch (BLOCKER)
**File:** `backend/src/utils/validators.ts` line 29-33  
**Severity:** Critical - Breaks all authentication  
**Status:** âœ… Fixed

**Problem:**
- Zod schema validates `email` field
- Controller code expects `username` field
- Results in validation failures for all login attempts

**Fix:**
```typescript
// Changed from:
export const loginSchema = z.object({
  email: z.string().email('Invalid email address'),
  password: z.string().min(1, 'Password is required'),
});

// To:
export const loginSchema = z.object({
  username: z.string().min(1, 'Username is required'),
  password: z.string().min(1, 'Password is required'),
});
```

### ğŸ”´ Bug #2: Migrations Not Running (BLOCKER)
**Severity:** Critical - Missing required schema  
**Status:** âš ï¸ Manually patched, needs proper fix

**Problem:**
- pgmigrations table has 0 rows
- Tables created but migrations didn't run
- Missing: backup_schedules, login_attempts tables
- Missing: role, twofa_enabled, twofa_secret columns in users

**Temporary Fix:**
- Manually added missing columns
- Created admin user manually

**Proper Fix Needed:**
- Ensure migrations run on container startup
- Add migration verification to health check
- Document manual migration process for Unraid

### ğŸŸ  Bug #3: Package Version Incompatibilities (HIGH)
**Severity:** High - Breaks Docker builds  
**Status:** âœ… Fixed

**Problems:**
1. xterm@5.5.0 doesn't exist (latest is 5.3.0)
2. xterm-addon-fit@0.9.0 doesn't exist (latest is 0.8.0)
3. @types/json2csv missing from devDependencies

**Fixes Applied:**
- Downgraded xterm to 5.3.0
- Downgraded xterm-addon-fit to 0.8.0
- Added @types/json2csv to backend devDependencies

---

## Additional Issues Found

### ğŸŸ¡ Database Connection User Mismatch
- Docker uses `medicine_user` but some scripts expected `postgres`
- Fixed by using correct username in all psql commands

### ğŸŸ¡ bcryptjs vs bcrypt Confusion
- Code uses `bcryptjs` package
- Initially tried to use `bcrypt` for password hashing
- Fixed by using bcryptjs for hash generation

### ğŸŸ¡ Redis Authentication
- Redis requires password for CLI commands
- Need to use `-a $REDIS_PASSWORD` for redis-cli

### ğŸŸ¡ Account Lockout System
- Works correctly (stores in Redis)
- Locked out during testing from failed attempts
- Lockout keys: `login_locked:{username}`, `login_attempts:{username}`
- Default: 5 attempts, 30-minute lockout

---

## Recommendations

### Immediate Actions (Before Production)
1. **âœ… COMPLETED:** Fix login schema mismatch
2. **ğŸ”´ CRITICAL:** Ensure migrations run properly on first startup
3. **ğŸ”´ CRITICAL:** Add migration status to health check endpoint
4. **ğŸŸ  HIGH:** Create comprehensive migration documentation
5. **ğŸŸ  HIGH:** Add automated tests for authentication flow
6. **ğŸŸ¡ MEDIUM:** Document manual database setup steps for Unraid

### Code Quality Improvements
1. Add integration tests for all auth endpoints
2. Add schema validation tests to catch mismatches
3. Improve error messages for failed logins
4. Add logging for migration status
5. Create database seeding script for development

### Documentation Needs
1. Database schema documentation
2. Migration troubleshooting guide
3. Manual setup instructions for Unraid
4. Admin user creation guide
5. Password reset procedures

---

## Testing Environment Details

### Software Versions
- Docker Desktop: 4.49.0
- Docker Engine: 28.5.1
- Docker Compose: 2.x
- Node.js (containers): 22-alpine
- PostgreSQL: 17-alpine
- Redis: 7-alpine
- Nginx: 1.27-alpine

### Test Methodology
1. Container health verification via `docker ps`
2. Resource monitoring via `docker stats`
3. API endpoint testing via PowerShell `Invoke-RestMethod`
4. Database inspection via `docker exec` + `psql`
5. Log analysis via `docker logs`
6. Manual UI testing (blocked)

---

## Conclusion

The application shows **excellent infrastructure and performance** characteristics but has **critical authentication bugs** that prevent it from being usable. The fixes for package versions and login schema have been applied, but **database migration issues remain critical**.

### Key Strengths
âœ… Excellent Docker container architecture  
âœ… Strong resource efficiency  
âœ… Good security practices (rate limiting, lockout)  
âœ… Comprehensive Unraid optimizations  
âœ… Portainer integration successful  

### Critical Gaps
âŒ Login authentication non-functional  
âŒ Database migrations not automated  
âŒ Missing required database tables  
âŒ No automated integration tests  

### Production Readiness: **NOT READY**
**Estimated time to production-ready:** 4-8 hours
- 2-4 hours: Fix migration system
- 1-2 hours: Comprehensive auth testing
- 1-2 hours: Documentation updates

---

## Files Modified During QA

1. **frontend/package.json** - Fixed xterm versions
2. **backend/src/utils/validators.ts** - Fixed login schema, fixed ValidationError calls
3. **backend/package.json** - Added @types/json2csv
4. **Database** - Manual schema fixes (3 ALTER TABLE commands)

---

**Report Generated:** November 11, 2025  
**Next QA Session:** After migration fixes are implemented
