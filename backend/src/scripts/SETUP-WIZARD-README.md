# Medicine Man Setup Wizard

An interactive command-line wizard for configuring the Medicine Man application from the Unraid terminal.

## Overview

The setup wizard guides you through the complete configuration process, automatically generating secure credentials and creating a production-ready `.env` file.

## Features

- **Auto-Generate Secure Values**: Automatically generates cryptographically secure keys and passwords
- **Interactive Prompts**: User-friendly step-by-step configuration
- **Input Validation**: Validates all inputs (ports, hostnames, numbers)
- **Configuration Summary**: Review before saving
- **Automatic Backup**: Backs up existing `.env` files with timestamp
- **Color-Coded Output**: Easy-to-read terminal interface with ANSI colors
- **Privacy-First**: Disables IP and User-Agent logging by default
- **Error Handling**: Graceful error handling and Ctrl+C support

## Quick Start

### From Unraid Terminal

1. Navigate to the application directory:
   ```bash
   cd /mnt/user/appdata/medicine-man/backend
   ```

2. Run the setup wizard:
   ```bash
   npm run setup
   # or
   npm run setup:wizard
   # or directly
   node src/scripts/setup-wizard.js
   ```

3. Follow the interactive prompts

4. Update your `docker-compose.yml` with the generated passwords

5. Start the containers:
   ```bash
   docker-compose up -d
   ```

## What Gets Configured

### 1. Secure Secrets (Auto-Generated)

The wizard automatically generates:
- **ENCRYPTION_KEY**: 64 hex characters for data encryption
- **JWT_SECRET**: 64 hex characters for JWT token signing
- **SESSION_SECRET**: 64 hex characters for session signing
- **DB_PASSWORD**: 32 character secure password for PostgreSQL
- **REDIS_PASSWORD**: 32 character secure password for Redis

You can optionally customize these values or accept the generated ones.

### 2. Environment Configuration

- **NODE_ENV**: production or development
  - Default: `production`
  - Affects logging verbosity and security settings

### 3. Database Configuration

- **DB_HOST**: PostgreSQL hostname
  - Default: `medicine_man_postgres`
- **DB_PORT**: PostgreSQL port
  - Default: `5432`
- **DB_NAME**: Database name
  - Default: `medicine_man`
- **DB_USER**: Database username
  - Default: `medicine_user`

### 4. Redis Configuration

- **REDIS_HOST**: Redis hostname
  - Default: `medicine_man_redis`
- **REDIS_PORT**: Redis port
  - Default: `6379`

### 5. Security Settings

- **Session Timeout**: How long sessions last
  - Default: `1 hour`
  - Range: 1-168 hours (1 week)
- **Max Login Attempts**: Failed login attempts before lockout
  - Default: `5`
  - Range: 1-20
- **Lockout Duration**: Account lockout duration after max attempts
  - Default: `30 minutes`
  - Range: 1-1440 minutes (24 hours)

### 6. Application Settings

- **CORS_ORIGIN**: Frontend URL for CORS
  - Default: `http://localhost:5173`
- **PORT**: Backend API port
  - Default: `3000`

### 7. Privacy Settings (Auto-Configured)

- **LOG_IP**: `false` - IP addresses are not logged
- **LOG_USER_AGENT**: `false` - User agents are not logged
- **REQUIRE_HTTPS**: `true` in production, `false` in development
- **LOG_LEVEL**: `warn` in production, `info` in development

## Generated .env File Structure

```env
# Medicine Man Configuration
# Generated by Setup Wizard on 2025-10-29T...

# ═══════════════════════════════════════════════════════════════
# Environment Configuration
# ═══════════════════════════════════════════════════════════════
NODE_ENV=production
PORT=3000
LOG_LEVEL=warn

# ═══════════════════════════════════════════════════════════════
# Database Configuration
# ═══════════════════════════════════════════════════════════════
DB_HOST=medicine_man_postgres
DB_PORT=5432
DB_NAME=medicine_man
DB_USER=medicine_user
DB_PASSWORD=<generated-32-char-password>

# ═══════════════════════════════════════════════════════════════
# Redis Configuration
# ═══════════════════════════════════════════════════════════════
REDIS_HOST=medicine_man_redis
REDIS_PORT=6379
REDIS_PASSWORD=<generated-32-char-password>

# ═══════════════════════════════════════════════════════════════
# Security Secrets
# ═══════════════════════════════════════════════════════════════
ENCRYPTION_KEY=<generated-64-hex-chars>
JWT_SECRET=<generated-64-hex-chars>
SESSION_SECRET=<generated-64-hex-chars>

# ... and more
```

## Backup System

If you already have a `.env` file, the wizard will automatically back it up:

```bash
backend/.env.backup.2025-10-29T18-30-45-123Z
```

This ensures you never lose your existing configuration.

## After Running the Wizard

### Step 1: Update docker-compose.yml

The wizard generates passwords but you need to update your `docker-compose.yml`:

```yaml
services:
  postgres:
    environment:
      POSTGRES_PASSWORD: <copy-from-DB_PASSWORD>

  redis:
    command: redis-server --requirepass <copy-from-REDIS_PASSWORD>
```

### Step 2: Start Docker Containers

```bash
docker-compose up -d
```

### Step 3: Wait for Services

Wait 30-60 seconds for PostgreSQL and Redis to be ready.

### Step 4: Run Migrations

```bash
cd backend
npm run migrate
```

### Step 5: Create Admin User

```bash
cd backend
node scripts/create-admin.js
```

### Step 6: Access the Application

- Frontend: http://localhost:5173 (or your CORS_ORIGIN)
- Backend API: http://localhost:3000 (or your PORT)

## Validation Rules

The wizard validates all inputs:

- **Ports**: Must be between 1-65535
- **Hostnames**: Alphanumeric, dots, dashes, underscores only
- **Session Timeout**: 1-168 hours
- **Max Login Attempts**: 1-20
- **Lockout Duration**: 1-1440 minutes
- **Environment**: Must be 'production' or 'development'

## Security Best Practices

1. **Never commit .env to version control**
   - Already in `.gitignore`
   - Contains sensitive credentials

2. **Use HTTPS in production**
   - Set `REQUIRE_HTTPS=true`
   - Configure SSL/TLS certificates

3. **Rotate secrets regularly**
   - Re-run wizard periodically
   - Update docker-compose.yml accordingly

4. **Restrict file permissions**
   - The wizard sets `.env` to 600 (owner read/write only)
   - Verify: `ls -la backend/.env`

5. **Secure your database**
   - Use strong generated passwords
   - Don't expose PostgreSQL/Redis ports externally
   - Enable SSL for database connections in production

6. **Review firewall rules**
   - Only expose necessary ports
   - Use reverse proxy for frontend

## Troubleshooting

### Wizard doesn't start

```bash
# Make sure you're in the backend directory
cd /mnt/user/appdata/medicine-man/backend

# Check Node.js is installed
node --version

# Run directly
node src/scripts/setup-wizard.js
```

### Permission denied

```bash
# Make the script executable
chmod +x src/scripts/setup-wizard.js
```

### Can't connect to database after setup

1. Verify docker-compose.yml has correct passwords
2. Check containers are running: `docker-compose ps`
3. Check logs: `docker-compose logs postgres`
4. Ensure you waited for services to be ready

### Want to change configuration

1. Simply re-run the wizard
2. Your old config will be backed up automatically
3. Or manually edit `backend/.env`

## Advanced Usage

### Non-Interactive Mode

For automation, you can create your own `.env` file without the wizard:

```bash
cp backend/.env.example backend/.env
# Edit backend/.env with your values
```

### Custom Secret Generation

If you prefer to generate secrets yourself:

```javascript
// Use the existing generateKey.ts script
cd backend
npx ts-node src/scripts/generateKey.ts
```

### Programmatic Access

The wizard is a standalone Node.js script. You can modify it or call its functions from other scripts if needed.

## Files Modified

- **Created**: `backend/.env`
- **Backed up** (if exists): `backend/.env.backup.TIMESTAMP`
- **Not modified**: Everything else

## Support

For issues or questions:
1. Check this README
2. Review the `.env.example` file
3. Check application logs
4. Consult the main Medicine Man documentation

## License

Part of the Medicine Man project - MIT License
